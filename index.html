<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜æ ¡ç”Ÿç‰© ãƒã‚¤ã‚ªãƒ¼ãƒ å­¦ç¿’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
    <!-- Tailwind CSSã®ãƒ­ãƒ¼ãƒ‰ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ•ã‚©ãƒ³ãƒˆè¨­å®šã¨åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            color: #1f2937; /* Dark Gray */
            padding: 1rem;
            min-height: 100vh;
        }

        /* â˜… è¿½åŠ : ãƒã‚¤ã‚ªãƒ¼ãƒ ç”»åƒã‚³ãƒ³ãƒ†ãƒŠ */
        #imageContainer {
            background-color: #e0e0e0; /* ç”»åƒãƒ­ãƒ¼ãƒ‰ä¸­ã®èƒŒæ™¯ */
            padding-bottom: 56.25%; /* 16:9 ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯” */
        }
        .biome-image {
            transition: opacity 0.5s ease-in-out; /* 0.5ç§’ã®ãƒ•ã‚§ãƒ¼ãƒ‰ */
        }


        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®è¦‹ãŸç›®ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4f46e5; /* Indigo */
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            transition: background 0.3s;
        }

        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }

        /* ãƒœã‚¿ãƒ³ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .biome-button {
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .biome-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .biome-button:active {
            transform: translateY(0);
        }

        /* LLMãƒœã‚¿ãƒ³ç”¨ã®ç‰¹æ®Šã‚¹ã‚¿ã‚¤ãƒ« */
        .llm-button {
            background-color: #f59e0b; /* Amber */
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .llm-button:hover {
            background-color: #d97706;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ */
        dialog::backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>

    <div id="app" class="max-w-4xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-extrabold text-indigo-700">ğŸŒ ãƒã‚¤ã‚ªãƒ¼ãƒ å­¦ç¿’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
            <p class="text-gray-600 mt-1">ç’°å¢ƒè¦å› ã‚’æ“ä½œã—ã¦ã€æ¤ç”Ÿã®å¤‰åŒ–ã¨ãƒã‚¤ã‚ªãƒ¼ãƒ ã‚’è¦³å¯Ÿã—ã‚ˆã†</p>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ (ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ç¸¦ä¸¦ã³ã€ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã¯æ¨ªä¸¦ã³) -->
        <div class="md:flex md:space-x-6">

            <!-- 1. ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« (å·¦å´/ä¸Šå´) -->
            <div class="md:w-1/3 bg-white p-6 rounded-xl shadow-lg mb-6 md:mb-0 space-y-4">
                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ç’°å¢ƒè¦å› ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h2>

                <!-- é™æ°´é‡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -->
                <div class="slider-group">
                    <label for="precipitation" class="block text-sm font-medium text-gray-700">å¹´é™æ°´é‡: <span id="precValue" class="font-semibold text-indigo-600">1500</span> mm</label>
                    <input type="range" id="precipitation" min="0" max="4000" step="10" value="1500" class="w-full">
                </div>

                <!-- æ°—æ¸©ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -->
                <div class="slider-group mt-4">
                    <label for="temperature" class="block text-sm font-medium text-gray-700">å¹´å¹³å‡æ°—æ¸©: <span id="tempValue" class="font-semibold text-indigo-600">10.0</span> Â°C</label>
                    <input type="range" id="temperature" min="-15" max="30" step="0.5" value="10" class="w-full">
                </div>

                <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
                <div class="flex space-x-4 pt-4 border-t mt-6">
                    <button id="resetButton" class="biome-button flex-1 py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium">åˆæœŸå€¤ã«æˆ»ã™</button>
                    <button id="randomButton" class="biome-button flex-1 py-2 px-4 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 font-medium">ãƒ©ãƒ³ãƒ€ãƒ è¨­å®š</button>
                </div>
                
                <!-- Gemini APIæ©Ÿèƒ½ãƒœã‚¿ãƒ³ -->
                <div class="pt-4 border-t mt-6 space-y-2">
                    <h3 class="text-sm font-bold text-gray-800">âœ¨ Gemini AI ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</h3>
                    <button id="quizButton" class="biome-button llm-button w-full py-2 px-4 rounded-lg">âœ¨ ã“ã®ãƒã‚¤ã‚ªãƒ¼ãƒ ã®ã‚¯ã‚¤ã‚º</button>
                    <button id="exploreButton" class="biome-button llm-button w-full py-2 px-4 rounded-lg">âœ¨ ã‚‚ã£ã¨è©³ã—ãèª¿ã¹ã‚‹</button>
                </div>
            </div>

            <!-- 2. Canvasæç”»ã¨æƒ…å ±ãƒ‘ãƒãƒ« (å³å´/ä¸‹å´) -->
            <div class="md:w-2/3 space-y-6">
                <!-- ãƒã‚¤ã‚ªãƒ¼ãƒ ç”»åƒã‚³ãƒ³ãƒ†ãƒŠ -->
                <div id="imageContainer" class="w-full relative rounded-xl shadow-lg overflow-hidden">
                    <!-- ç”»åƒã¯JavaScriptã«ã‚ˆã£ã¦ãƒ•ã‚§ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆã•ã‚Œã¾ã™ -->
                    <img id="biomeImageBack" src="" alt="ãƒã‚¤ã‚ªãƒ¼ãƒ ã®ã‚¤ãƒ¡ãƒ¼ã‚¸" class="biome-image absolute top-0 left-0 w-full h-full object-cover opacity-0">
                    <img id="biomeImageFront" src="" alt="ãƒã‚¤ã‚ªãƒ¼ãƒ ã®ã‚¤ãƒ¡ãƒ¼ã‚¸" class="biome-image absolute top-0 left-0 w-full h-full object-cover opacity-100">
                </div>

                <!-- æƒ…å ±è¡¨ç¤ºãƒ‘ãƒãƒ« -->
                <div id="infoPanel" class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500">
                    <h2 id="biomeName" class="text-2xl font-extrabold text-indigo-800 mb-2">ç†±å¸¯å¤šé›¨æ—</h2>
                    <p id="biomeDescription" class="text-gray-700 mb-3 leading-relaxed">
                        å¹´ä¸­é«˜æ¸©å¤šæ¹¿ã§ã€å¤šå±¤æ§‹é€ ã®å·¨å¤§ãªå¸¸ç·‘åºƒè‘‰æ¨¹æ—ã€‚
                    </p>
                    <div class="text-sm">
                        <span class="font-semibold text-gray-600">ä»£è¡¨ä¾‹:</span>
                        <span id="biomeExamples" class="text-gray-700">ãƒ•ã‚¿ãƒã‚¬ã‚­, ã‚ªã‚ªã‚´ãƒãƒ€ãƒ©, é¡äººçŒ¿</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
        <footer class="mt-8 text-center text-sm text-gray-500">
            <!-- ãƒ’ãƒ³ãƒˆã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ -->
        </footer>

    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚° (çµæœè¡¨ç¤ºç”¨) -->
    <dialog id="resultModal" class="p-6 rounded-xl shadow-2xl w-full max-w-lg">
        <h3 id="modalTitle" class="text-xl font-bold mb-4 text-indigo-700">çµæœ</h3>
        <div id="modalContent" class="mb-6 overflow-y-auto max-h-96 text-gray-700">
            <!-- çµæœãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
            <div class="loader mx-auto"></div>
            <p id="modalMessage" class="text-center mt-4">AIãŒå›ç­”ã‚’ç”Ÿæˆä¸­ã§ã™...</p>
        </div>
        <button id="modalCloseButton" class="w-full py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium">é–‰ã˜ã‚‹</button>
    </dialog>

    <script>
        // ===============================================
        // JavaScript / ãƒãƒƒãƒ—ãƒ­ã‚¸ãƒƒã‚¯
        // ===============================================

        // â˜… æ›´æ–°: BIOMES_DATA ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åã‚’ã™ã¹ã¦åŠè§’è‹±æ•°å­—ã«å¤‰æ›´
        const BIOMES_DATA = {
            'ç†±å¸¯å¤šé›¨æ—': { P: 3000, T: 25, description: 'å¹´ä¸­é«˜æ¸©å¤šæ¹¿ã§ã€å¤šå±¤æ§‹é€ ã®å·¨å¤§ãªå¸¸ç·‘åºƒè‘‰æ¨¹æ—ã€‚', examples: ['ãƒ•ã‚¿ãƒã‚¬ã‚­', 'ã‚ªã‚ªã‚´ãƒãƒ€ãƒ©', 'é¡äººçŒ¿'], colors: { ground: '#006400' }, 
                imageSrc: 'subtropical_rainforest.jpg' }, // â˜… å¤‰æ›´: äºœç†±å¸¯å¤šé›¨æ—ã®ç”»åƒã‚’ä»£ç”¨
            'äºœç†±å¸¯å¤šé›¨æ—': { P: 2000, T: 20, description: 'ç†±å¸¯ã¨æ¸©å¸¯ã®é–“ã«ä½ç½®ã™ã‚‹ã€é™æ°´é‡ãŒå¤šã„å¸¸ç·‘åºƒè‘‰æ¨¹æ—ã€‚', examples: ['ã‚¬ã‚¸ãƒ¥ãƒãƒ«', 'ã‚¢ãƒ€ãƒ³', 'ãƒ¤ãƒ³ãƒãƒ«ã‚¯ã‚¤ãƒŠ'], colors: { ground: '#228B22' }, 
                imageSrc: 'subtropical_rainforest.jpg' }, // â˜… å¤‰æ›´
            'é›¨ç·‘æ¨¹æ—': { P: 1200, T: 25, description: 'ä¹¾å­£ã¨é›¨å­£ãŒæ˜ç¢ºãªç†±å¸¯ãƒ»äºœç†±å¸¯åœ°åŸŸã«è¦‹ã‚‰ã‚Œã‚‹ã€ä¹¾å­£ã«è½è‘‰ã™ã‚‹æ¨¹æ—ã€‚', examples: ['ãƒãƒ¼ã‚¯', 'ãƒãƒ›ã‚¬ãƒ‹ãƒ¼', 'ã‚¢ã‚¸ã‚¢ã‚¾ã‚¦'], colors: { ground: '#556B2F' }, 
                imageSrc: 'deciduous_rainforest.jpg' }, // â˜… å¤‰æ›´
            'ç…§è‘‰æ¨¹æ—': { P: 1500, T: 15, description: 'æ¸©æš–ã§é™æ°´é‡ã®å¤šã„åœ°åŸŸã«ç™ºé”ã™ã‚‹ã€å…‰æ²¢ã®ã‚ã‚‹è‘‰ã‚’æŒã¤å¸¸ç·‘åºƒè‘‰æ¨¹æ—ã€‚', examples: ['ã‚«ã‚·', 'ã‚·ã‚¤', 'ãƒ„ãƒã‚­', 'ãƒ‹ãƒ›ãƒ³ã‚¸ã‚«'], colors: { ground: '#38761D' }, 
                imageSrc: 'laurel_forest.jpg' }, // â˜… å¤‰æ›´
            'å¤ç·‘æ¨¹æ—': { P: 1200, T: 10, description: 'å››å­£ãŒã‚ã‚Šå†¬ã«è½è‘‰ã™ã‚‹åºƒè‘‰æ¨¹ãŒå„ªå ã™ã‚‹æ¸©å¸¯æ—ã€‚', examples: ['ãƒ–ãƒŠ', 'ã‚«ã‚¨ãƒ‡', 'ãƒŠãƒ©', 'ã‚¯ãƒ'], colors: { ground: '#8B4513' }, 
                imageSrc: 'summergreen_forest.jpg' }, // â˜… å¤‰æ›´
            'ç¡¬è‘‰æ¨¹æ—': { P: 700, T: 15, description: 'å¤ã«ä¹¾ç‡¥ã—å†¬ã«é›¨ãŒé™ã‚‹åœ°ä¸­æµ·æ€§æ°—å€™åœ°åŸŸã«è¦‹ã‚‰ã‚Œã‚‹ã€ç¡¬ã„è‘‰ã‚’æŒã¤æ¨¹æ—ã€‚', examples: ['ã‚ªãƒªãƒ¼ãƒ–', 'ã‚³ãƒ«ã‚¯ã‚¬ã‚·', 'ãƒ¤ã‚®'], colors: { ground: '#90EE90' }, 
                imageSrc: 'hardwood_forest.jpg' }, // â˜… å¤‰æ›´
            'é‡è‘‰æ¨¹æ—': { P: 600, T: 0, description: 'å¯’å†·ãªåœ°åŸŸã«åºƒãŒã‚‹ã€ãƒˆã‚¦ãƒ’ã‚„ãƒ¢ãƒŸãªã©ã®é‡è‘‰æ¨¹ãŒå„ªå ã™ã‚‹åŒ—æ–¹æ—ï¼ˆã‚¿ã‚¤ã‚¬ï¼‰ã€‚', examples: ['ãƒˆã‚¦ãƒ’', 'ãƒ¢ãƒŸ', 'ãƒ˜ãƒ©ã‚¸ã‚«'], colors: { ground: '#556B2F' }, 
                imageSrc: 'coniferous_forest.jpg' }, // â˜… å¤‰æ›´
            'ã‚¹ãƒ†ãƒƒãƒ—': { P: 400, T: 15, description: 'æ¸©å¸¯ã®å†…é™¸éƒ¨ã«åºƒãŒã‚‹ä¹¾ç‡¥ã—ãŸè‰åŸã€‚', examples: ['ã‚¤ãƒç§‘æ¤ç‰©', 'ã‚­ã‚¯ç§‘æ¤ç‰©', 'ã‚¦ã‚µã‚®'], colors: { ground: '#DAA520' }, 
                imageSrc: 'steppe.jpg' }, // â˜… å¤‰æ›´
            'ã‚µãƒãƒ³ãƒŠ': { P: 800, T: 25, description: 'å­£ç¯€çš„ã«é›¨ãŒé™ã‚‹ç†±å¸¯ã®è‰åŸã€‚ç–æ—ã¨é•·è‰æœ¬ãŒå„ªå ã€‚', examples: ['ãƒã‚ªãƒãƒ–', 'ã‚¢ã‚«ã‚·ã‚¢', 'ã‚·ãƒã‚¦ãƒ'], colors: { ground: '#DAA520' }, 
                imageSrc: 'savanna.jpg' }, // â˜… å¤‰æ›´
            'ãƒ„ãƒ³ãƒ‰ãƒ©': { P: 300, T: -10, description: 'æ¥µã‚ã¦å¯’å†·ã§ã€æ°¸ä¹…å‡åœŸãŒåºƒãŒã‚Šã€åœ°è¡£é¡ã‚„ã‚³ã‚±é¡ãŒç”Ÿè‚²ã€‚', examples: ['åœ°è¡£é¡', 'ã‚³ã‚±é¡', 'ã‚«ãƒªãƒ–ãƒ¼', 'ãƒ›ãƒƒã‚­ãƒ§ã‚¯ã‚°ãƒ'], colors: { ground: '#C0C0C0' }, 
                imageSrc: 'tundra.jpg' }, // â˜… å¤‰æ›´
            'ç ‚æ¼ ': { P: 100, T: 20, description: 'é™æ°´é‡ãŒæ¥µã‚ã¦å°‘ãªãã€é«˜æ¸©ã§ã€ä¹¾ç‡¥ã«é©å¿œã—ãŸæ¤ç‰©ãŒç”Ÿè‚²ã€‚', examples: ['ã‚µãƒœãƒ†ãƒ³', 'ã‚¢ãƒ­ã‚¨', 'ãƒ©ã‚¯ãƒ€', 'ã‚¹ãƒŠãƒã‚³'], colors: { ground: '#D2B48C' }, 
                imageSrc: 'desert.jpg' }, // â˜… å¤‰æ›´
        };

        const imageContainer = document.getElementById('imageContainer');
        // â˜… è¿½åŠ : ç”»åƒè¦ç´ 
        let imgFront = document.getElementById('biomeImageFront');
        let imgBack = document.getElementById('biomeImageBack');
        
        // UIè¦ç´ 
        const precSlider = document.getElementById('precipitation');
        const tempSlider = document.getElementById('temperature');
        const precValueSpan = document.getElementById('precValue');
        const tempValueSpan = document.getElementById('tempValue');
        const biomeNameDisplay = document.getElementById('biomeName');
        const biomeDescDisplay = document.getElementById('biomeDescription');
        const biomeExamplesDisplay = document.getElementById('biomeExamples');
        const resetButton = document.getElementById('resetButton');
        const randomButton = document.getElementById('randomButton');
        const quizButton = document.getElementById('quizButton');
        const exploreButton = document.getElementById('exploreButton');
        const infoPanel = document.getElementById('infoPanel');
        const resultModal = document.getElementById('resultModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');
        const modalCloseButton = document.getElementById('modalCloseButton');
        
        // State
        let currentPrec = parseFloat(precSlider.value);
        let currentTemp = parseFloat(tempSlider.value);

        // Pã¨Tã‹ã‚‰ãƒã‚¤ã‚ªãƒ¼ãƒ åã‚’åˆ¤å®šã™ã‚‹é–¢æ•°
        function determineBiome(P, T) {
            // å„ªå…ˆé †ä½: å¯’å†· > ä¹¾ç‡¥ > ãã®ä»–
            if (T < -10) { // -15â„ƒã«è¿‘ã¥ãã¨ãƒ„ãƒ³ãƒ‰ãƒ©
                return BIOMES_DATA['ãƒ„ãƒ³ãƒ‰ãƒ©'];
            }
            if (P < 250) {
                return BIOMES_DATA['ç ‚æ¼ '];
            }
            
            // ç†±å¸¯ (T > 20)
            if (T > 20) {
                if (P > 2000) return BIOMES_DATA['ç†±å¸¯å¤šé›¨æ—'];
                if (P > 1000) return BIOMES_DATA['é›¨ç·‘æ¨¹æ—'];
                if (P > 300) return BIOMES_DATA['ã‚µãƒãƒ³ãƒŠ'];
                return BIOMES_DATA['ç ‚æ¼ ']; // T>20, P<300
            }
            // äºœç†±å¸¯ãƒ»æš–æ¸©å¸¯ (T > 15)
            if (T > 15) {
                if (P > 1800) return BIOMES_DATA['äºœç†±å¸¯å¤šé›¨æ—'];
                if (P > 800) return BIOMES_DATA['ç…§è‘‰æ¨¹æ—'];
                if (P > 300) return BIOMES_DATA['ã‚¹ãƒ†ãƒƒãƒ—'];
                return BIOMES_DATA['ç ‚æ¼ '];
            }
            // å†·æ¸©å¸¯ (T > 5)
            if (T > 5) {
                if (P > 1000) return BIOMES_DATA['å¤ç·‘æ¨¹æ—'];
                if (P > 400) return BIOMES_DATA['ç¡¬è‘‰æ¨¹æ—'];
                return BIOMES_DATA['ã‚¹ãƒ†ãƒƒãƒ—'];
            }
            // äºœå¯’å¸¯ (T > -10)
            if (T > -10) {
                if (P > 400) return BIOMES_DATA['é‡è‘‰æ¨¹æ—'];
                return BIOMES_DATA['ãƒ„ãƒ³ãƒ‰ãƒ©']; // TãŒ-10~5ã§PãŒå°‘ãªã„
            }
            
            return BIOMES_DATA['ãƒ„ãƒ³ãƒ‰ãƒ©']; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ (-10ä»¥ä¸‹)
        }
        
        // â˜… è¿½åŠ : ãƒã‚¤ã‚ªãƒ¼ãƒ åã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function getBiomeName(biomeData) {
            for (const key in BIOMES_DATA) {
                if (BIOMES_DATA[key].description === biomeData.description) {
                    return key;
                }
            }
            return 'ä¸æ˜';
        }
        
        // â˜… è¿½åŠ : ç”»åƒã‚’ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰ã§æ›´æ–°ã™ã‚‹é–¢æ•°
        let isFading = false;
        let currentImageSrc = ''; // ç¾åœ¨è¡¨ç¤ºä¸­ã®ç”»åƒãƒ‘ã‚¹ã‚’è¿½è·¡
        
        function updateBiomeImage(newImageSrc) {
            // æ–°ã—ã„ç”»åƒãŒç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚‚ã®ã¨åŒã˜ã€ã¾ãŸã¯ãƒ•ã‚§ãƒ¼ãƒ‰ä¸­ãªã‚‰ä½•ã‚‚ã—ãªã„
            if (newImageSrc === currentImageSrc || isFading) {
                return;
            }
            
            currentImageSrc = newImageSrc; // è¡¨ç¤ºã™ã‚‹ç”»åƒãƒ‘ã‚¹ã‚’æ›´æ–°
            isFading = true;
            
            // 1. èƒŒé¢(Back)ã®imgã‚¿ã‚°ã«æ–°ã—ã„ç”»åƒã‚’è¨­å®š
            imgBack.src = newImageSrc;
            
            // 2. èƒŒé¢(Back)ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
            imgBack.style.opacity = 1;
            // 3. å‰é¢(Front)ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
            imgFront.style.opacity = 0;

            // 4. ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œ (0.5ç§’) ã«å‚ç…§ã‚’å…¥ã‚Œæ›¿ãˆã‚‹
            setTimeout(() => {
                // Front ã¨ Back ã®DOMå‚ç…§ã‚’å…¥ã‚Œæ›¿ãˆã‚‹
                [imgFront, imgBack] = [imgBack, imgFront];
                isFading = false;
            }, 500); // CSSã®transitionæ™‚é–“ã¨åˆã‚ã›ã‚‹
        }


        // ===============================================
        // Gemini API é–¢é€£ãƒ­ã‚¸ãƒƒã‚¯ 
        // ===============================================

        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const API_KEY = ""; // CanvasãŒå®Ÿè¡Œæ™‚ã«æä¾›

        async function callGeminiApi(payload, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < retries - 1) {
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    if (i === retries - 1) {
                        console.error("Gemini API call failed after multiple retries:", error);
                        throw new Error("APIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚");
                    }
                }
            }
        }
        
        function showLoadingModal(title, message) {
            modalTitle.textContent = title;
            modalContent.innerHTML = `<div class="loader mx-auto"></div><p class="text-center mt-4">${message}</p>`;
            resultModal.showModal();
        }

        quizButton.addEventListener('click', async () => {
            const biomeName = biomeNameDisplay.textContent;
            const biomeDesc = biomeDescDisplay.textContent;
            showLoadingModal('âœ¨ ãƒã‚¤ã‚ªãƒ¼ãƒ çŸ¥è­˜ã‚¯ã‚¤ã‚º', `${biomeName}ã«é–¢ã™ã‚‹4æŠã‚¯ã‚¤ã‚ºã‚’ç”Ÿæˆä¸­ã§ã™...`);
            quizButton.disabled = true;
            exploreButton.disabled = true;

            const systemPrompt = `ã‚ãªãŸã¯é«˜æ ¡ç”Ÿå‘ã‘ã®ç”Ÿç‰©ã®å…ˆç”Ÿã§ã™ã€‚æä¾›ã•ã‚ŒãŸãƒã‚¤ã‚ªãƒ¼ãƒ åã¨èª¬æ˜ã«åŸºã¥ãã€ãã®çŸ¥è­˜ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®ã€é›£æ˜“åº¦ãŒé«˜ã™ããªã„4æŠã®å¤šè‚¢é¸æŠã‚¯ã‚¤ã‚ºã‚’1å•ã€æ—¥æœ¬èªã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚å›ç­”ã¯å¿…ãšæä¾›ã•ã‚ŒãŸJSONã‚¹ã‚­ãƒ¼ãƒã«å¾“ã£ã¦ãã ã•ã„ã€‚`;
            const quizSchema = {
                type: "OBJECT",
                properties: {
                    question: { type: "STRING", description: "ã‚¯ã‚¤ã‚ºã®è³ªå•æ–‡ã€‚" },
                    options: {
                        type: "ARRAY",
                        items: { type: "STRING" },
                        description: "å¿…ãš4ã¤ã®é¸æŠè‚¢ã‚’é…åˆ—ã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚"
                    },
                    correctAnswerIndex: { type: "NUMBER", description: "æ­£è§£ã®é¸æŠè‚¢ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (0ã€œ3)ã€‚" },
                    explanation: { type: "STRING", description: "æ­£è§£ã®ç†ç”±ã¨ã€ãªãœä»–ã®é¸æŠè‚¢ãŒé•ã†ã®ã‹ã«ã¤ã„ã¦ã®ç°¡å˜ãªè§£èª¬ã€‚" }
                },
                propertyOrdering: ["question", "options", "correctAnswerIndex", "explanation"]
            };
            const userQuery = `ãƒã‚¤ã‚ªãƒ¼ãƒ å: ${biomeName}\nèª¬æ˜: ${biomeDesc}\nã“ã®æƒ…å ±ã«åŸºã¥ãã€4æŠã‚¯ã‚¤ã‚ºã‚’1å•ä½œæˆã—ã¦ãã ã•ã„ã€‚`;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: quizSchema,
                },
            };
            try {
                const result = await callGeminiApi(payload);
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) throw new Error("ã‚¯ã‚¤ã‚ºç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                const quiz = JSON.parse(jsonText);
                if (!quiz.options || quiz.options.length !== 4 || quiz.correctAnswerIndex === undefined) {
                    throw new Error("ã‚¯ã‚¤ã‚ºã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
                }
                const html = `
                    <div class="space-y-4">
                        <p class="font-semibold text-lg text-indigo-800">å•é¡Œ:</p>
                        <p class="bg-indigo-50 p-3 rounded-lg border-l-4 border-indigo-400">${quiz.question}</p>
                        <p class="font-semibold text-md text-gray-700 mt-4">é¸æŠè‚¢:</p>
                        <ul class="list-decimal list-inside space-y-2 ml-2 text-gray-700">
                            ${quiz.options.map((opt, index) => `<li>${opt}</li>`).join('')}
                        </ul>
                        <details class="p-4 bg-green-50 rounded-lg border-l-4 border-green-400 mt-4">
                            <summary class="cursor-pointer font-bold text-green-700 text-base">ç­”ãˆã¨è§£èª¬ã‚’è¦‹ã‚‹</summary>
                            <p class="mt-2 text-green-900"><strong>æ­£è§£:</strong> ${quiz.options[quiz.correctAnswerIndex]}</p>
                            <p class="mt-1 text-green-900"><strong>è§£èª¬:</strong> ${quiz.explanation}</p>
                        </details>
                    </div>
                `;
                modalContent.innerHTML = html;
            } catch (error) {
                modalContent.innerHTML = `<p class="text-red-600">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            } finally {
                quizButton.disabled = false;
                exploreButton.disabled = false;
            }
        });

        exploreButton.addEventListener('click', async () => {
            const biomeName = biomeNameDisplay.textContent;
            showLoadingModal('âœ¨ ãƒã‚¤ã‚ªãƒ¼ãƒ æ¢æ±‚ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ', `${biomeName}ã®ãƒªã‚¢ãƒ«ãªæƒ…å ±ã‚’æ¤œç´¢ä¸­ã§ã™...`);
            quizButton.disabled = true;
            exploreButton.disabled = true;
            const systemPrompt = `ã‚ãªãŸã¯ã€é«˜æ ¡ç”ŸãŒãƒã‚¤ã‚ªãƒ¼ãƒ å­¦ç¿’ã‚’æ·±ã‚ã‚‹ãŸã‚ã®æ¢æ±‚ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚æä¾›ã•ã‚ŒãŸãƒã‚¤ã‚ªãƒ¼ãƒ åã«åŸºã¥ãã€ä»¥ä¸‹ã®3ã¤ã®é …ç›®ã®ã¿ã«ã¤ã„ã¦ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã§æ¤œç´¢ã—ã€ç°¡æ½”ãªç®‡æ¡æ›¸ãã§ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚
1. ä»£è¡¨çš„ãªå›½ã‚„åœ°åŸŸ
2. ãã“ã«ç”Ÿæ¯ã™ã‚‹å›ºæœ‰ç¨®ã¾ãŸã¯ã‚­ãƒ¼ã‚¹ãƒˆãƒ¼ãƒ³ç¨®
3. ãã®åœ°åŸŸã§ç™ºç”Ÿã—ã¦ã„ã‚‹äººé–“æ´»å‹•ãŒé–¢ã‚ã‚‹ç’°å¢ƒå•é¡Œ
æƒ…å ±ã¯å¿…ãšæ—¥æœ¬èªã§ã€ç®‡æ¡æ›¸ãã®å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚`;
            const userQuery = `ãƒã‚¤ã‚ªãƒ¼ãƒ å: ${biomeName}ã€‚\nã“ã®ãƒã‚¤ã‚ªãƒ¼ãƒ ã«ã¤ã„ã¦ã€æŒ‡å®šã•ã‚ŒãŸ3ã¤ã®é …ç›®ï¼ˆä»£è¡¨åœ°åŸŸã€å›ºæœ‰ç¨®/ã‚­ãƒ¼ã‚¹ãƒˆãƒ¼ãƒ³ç¨®ã€äººé–“æ´»å‹•ã«ã‚ˆã‚‹ç’°å¢ƒå•é¡Œï¼‰ã‚’èª¿ã¹ã¦ãã ã•ã„ã€‚`;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ systemPrompt }] },
            };
            try {
                const result = await callGeminiApi(payload);
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
                let sourcesHtml = '';
                const groundingMetadata = result.candidates?.[0]?.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    const sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title)
                        .slice(0, 3); 
                    if (sources.length > 0) {
                        sourcesHtml = `<div class="mt-4 pt-3 border-t text-xs text-gray-500">
                            <p class="font-semibold mb-1">å‚è€ƒæƒ…å ±:</p>
                            ${sources.map((s, index) => 
                                `<p>${index + 1}. <a href="${s.uri}" target="_blank" class="text-indigo-500 hover:text-indigo-700">${s.title}</a></p>`
                            ).join('')}
                        </div>`;
                    }
                }
                const formattedText = text
                                          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                          .replace(/^1\.\s(.*?)$/gm, '<h3>1. ä»£è¡¨çš„ãªå›½ã‚„åœ°åŸŸ</h3><p>$1</p>')
                                          .replace(/^2\.\s(.*?)$/gm, '<h3>2. å›ºæœ‰ç¨®ãƒ»ã‚­ãƒ¼ã‚¹ãƒˆãƒ¼ãƒ³ç¨®</h3><p>$1</p>')
                                          .replace(/^3\.\s(.*?)$/gm, '<h3>3. äººé–“æ´»å‹•ã«ã‚ˆã‚‹ç’°å¢ƒå•é¡Œ</h3><p>$1</p>')
                                          .replace(/\* (.*)/g, '<li>$1</li>')
                                          .replace(/<li>/g, '<li class="ml-4">')
                                          .replace(/<h3>/g, '<h3 class="text-md font-semibold text-indigo-700 mt-3 mb-1">');
                modalContent.innerHTML = `
                    <div class="prose max-w-none text-gray-800">
                        ${formattedText}
                    </div>
                    ${sourcesHtml}
                `;
            } catch (error) {
                modalContent.innerHTML = `<p class="text-red-600">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            } finally {
                quizButton.disabled = false;
                exploreButton.disabled = false;
            }
        });


        // ===============================================
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© (ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å¯¾å¿œ)
        // ===============================================

        // â˜… æ›´æ–°: ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å¤‰æ›´ãƒ­ã‚¸ãƒƒã‚¯
        function handleSliderChange() {
            currentPrec = parseFloat(precSlider.value);
            currentTemp = parseFloat(tempSlider.value);
            
            // UIã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
            precValueSpan.textContent = currentPrec;
            tempValueSpan.textContent = currentTemp.toFixed(1);

            // ãƒã‚¤ã‚ªãƒ¼ãƒ ã®æ±ºå®š
            const newBiomeData = determineBiome(currentPrec, currentTemp);
            const biomeName = getBiomeName(newBiomeData);
            
            // æƒ…å ±ãƒ‘ãƒãƒ«ã®æ›´æ–°
            if (biomeNameDisplay.textContent !== biomeName) {
                biomeNameDisplay.textContent = biomeName;
                biomeDescDisplay.textContent = newBiomeData.description;
                biomeExamplesDisplay.textContent = newBiomeData.examples.join(', ');
                infoPanel.style.borderColor = newBiomeData.colors.ground; // è‰²ã¯ãƒ‡ãƒ¼ã‚¿ã«æ®‹ã—ã¦ãŠã
            }

            // â˜… ãƒãƒƒãƒ—ãƒã‚¤ãƒ³ãƒˆã®ä»£ã‚ã‚Šã«ç”»åƒæ›´æ–°ã‚’å‘¼ã³å‡ºã™
            updateBiomeImage(newBiomeData.imageSrc);
        }

        // åˆæœŸåŒ–ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        function initialize() {
            // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            precSlider.addEventListener('input', handleSliderChange);
            tempSlider.addEventListener('input', handleSliderChange);

            // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ (åˆæœŸå€¤: å¤ç·‘æ¨¹æ—ã‚ãŸã‚Š)
            resetButton.addEventListener('click', () => {
                precSlider.value = 1500;
                tempSlider.value = 10;
                handleSliderChange();
            });

            // ãƒ©ãƒ³ãƒ€ãƒ è¨­å®šãƒœã‚¿ãƒ³
            randomButton.addEventListener('click', () => {
                // æ–°ã—ã„ç¯„å›²ã«å¯¾å¿œ
                precSlider.value = Math.floor(Math.random() * 401) * 10; // 0-4000
                tempSlider.value = (Math.random() * 45 - 15).toFixed(1); // -15.0 - 30.0
                handleSliderChange();
            });
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¯ãƒ­ãƒ¼ã‚º
            modalCloseButton.addEventListener('click', () => {
                resultModal.close();
            });
            
            // â˜… ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«åˆå›å®Ÿè¡Œ
            handleSliderChange();
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œã«åˆæœŸåŒ–
        window.onload = initialize;

    </script>
</body>
</html>
